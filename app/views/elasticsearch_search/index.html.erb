<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'search_results' %>
<% end %>

<h2><%= l(:label_advanced_search) %></h2>

<%= form_tag(elasticsearch_search_path, method: :get, id: 'es-search-form') do %>
  <div class="search-form-modern">
    <div class="search-input-row">
      <%= text_field_tag 'q', @question, size: 60, placeholder: l(:label_search_placeholder), id: 'search-input' %>
      <%= submit_tag l(:button_search), name: nil, class: 'search-submit-btn' %>
    </div>

    <fieldset class="collapsible collapsed" style="margin-top: 12px; border: 1px solid #ddd; border-radius: 6px;">
      <legend onclick="toggleFieldset(this);" style="cursor: pointer; padding: 0 8px; font-weight: 500;">
        <%= l(:label_search_options) %>
      </legend>
      <div style="display: none; padding: 12px;">
        <div class="es-options-grid">
          <div class="es-option-group">
            <label class="es-option-label"><%= l(:label_search_in) %>:</label>
            <div class="es-option-choices">
              <label class="es-radio">
                <%= radio_button_tag 'search_in', 'all', @search_in == 'all' %>
                <%= l(:label_search_in_all) %>
              </label>
              <label class="es-radio">
                <%= radio_button_tag 'search_in', 'title', @search_in == 'title' %>
                <%= l(:label_search_in_title) %>
              </label>
              <label class="es-radio">
                <%= radio_button_tag 'search_in', 'content', @search_in == 'content' %>
                <%= l(:label_search_in_content) %>
              </label>
            </div>
          </div>

          <div class="es-option-group">
            <label class="es-option-label"><%= l(:label_sort_by) %>:</label>
            <%= select_tag 'sort_by', options_for_select([
              [l(:label_sort_relevance), 'relevance'],
              [l(:label_sort_date_desc), 'date_desc'],
              [l(:label_sort_date_asc), 'date_asc'],
              [l(:label_sort_updated_desc), 'updated_desc']
            ], @sort_by), class: 'es-select' %>
          </div>

          <div class="es-option-group">
            <label class="es-option-label"><%= l(:label_date_range) %>:</label>
            <div class="es-date-inputs">
              <%= text_field_tag 'date_from', @date_from, size: 10, class: 'date-input', placeholder: 'YYYY-MM-DD' %>
              <span>-</span>
              <%= text_field_tag 'date_to', @date_to, size: 10, class: 'date-input', placeholder: 'YYYY-MM-DD' %>
            </div>
          </div>

          <div class="es-option-group">
            <label class="es-checkbox">
              <%= check_box_tag 'include_closed', '1', @include_closed %>
              <%= l(:label_include_closed_issues) %>
            </label>
          </div>

          <% if @available_projects.any? %>
            <div class="es-option-group es-option-full">
              <label class="es-option-label"><%= l(:label_project_plural) %>:</label>
              <%= select_tag 'project_ids[]',
                  options_from_collection_for_select(@available_projects, :id, :name, @project_ids.map(&:to_i)),
                  multiple: true, size: 4, class: 'es-project-select' %>
              <span class="es-hint"><%= l(:text_select_multiple_hint) %></span>
            </div>
          <% end %>
        </div>
      </div>
    </fieldset>
  </div>
<% end %>

<% if @question.present? && @results %>
  <div class="search-container">
    <% if @aggregations.present? %>
      <aside class="search-sidebar">
        <% if @aggregations[:by_type]&.any? %>
          <div class="search-filter-panel">
            <h4><%= l(:label_content_types) %></h4>
            <ul class="search-type-filters">
              <% @aggregations[:by_type].each do |agg| %>
                <% is_active = @types.size == 1 && @types.include?(agg[:key]) %>
                <li class="<%= 'active' if is_active %>">
                  <%= link_to elasticsearch_search_path(q: @question, types: [agg[:key]], search_in: @search_in, sort_by: @sort_by) do %>
                    <span class="filter-icon"><%= sprite_icon(agg[:key]) %></span>
                    <span class="filter-label"><%= agg[:label] %></span>
                    <span class="filter-count"><%= agg[:count] %></span>
                  <% end %>
                </li>
              <% end %>
            </ul>
            <% if @types.size == 1 %>
              <p style="margin: 12px 0 0; text-align: center;">
                <%= link_to l(:label_show_all_types), elasticsearch_search_path(q: @question, search_in: @search_in, sort_by: @sort_by), style: 'font-size: 12px; color: #666;' %>
              </p>
            <% end %>
          </div>
        <% end %>

        <% if @aggregations[:by_project]&.any? %>
          <div class="search-filter-panel">
            <h4><%= l(:label_project_plural) %></h4>
            <ul class="search-type-filters">
              <% @aggregations[:by_project].first(8).each do |agg| %>
                <% is_active = @project_ids.map(&:to_i).include?(agg[:key].to_i) %>
                <li class="<%= 'active' if is_active %>">
                  <%= link_to elasticsearch_search_path(q: @question, project_ids: [agg[:key]], search_in: @search_in, sort_by: @sort_by) do %>
                    <span class="filter-label"><%= agg[:label] %></span>
                    <span class="filter-count"><%= agg[:count] %></span>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="search-filter-panel">
          <p style="margin: 0; text-align: center;">
            <%= link_to l(:label_search), search_path(q: @question), style: 'font-size: 12px; color: #666;' %>
          </p>
        </div>
      </aside>
    <% end %>

    <main class="search-results-main">
      <div class="search-results-header">
        <h3><%= l(:label_search_results) %> (<%= @result_count %>)</h3>
        <% if @sort_by %>
          <span class="search-results-meta">
            <%= l(:label_sorted_by) %>: <%= l("label_sort_#{@sort_by}", default: @sort_by.humanize) %>
          </span>
        <% end %>
      </div>

      <% if @results.any? %>
        <div class="search-results-list" id="search-results-list">
          <% @results.each do |result| %>
            <%= render partial: 'elasticsearch_search/result_card', locals: { result: result } %>
          <% end %>
        </div>

        <% if @result_pages %>
          <div class="search-pagination">
            <%= pagination_links_full @result_pages, @result_count %>
          </div>
        <% end %>
      <% else %>
        <div class="search-no-results">
          <%= sprite_icon('search') %>
          <h4><%= l(:label_no_data) %></h4>
          <p><%= l(:text_no_search_results) %></p>
        </div>
      <% end %>
    </main>
  </div>
<% elsif @question.present? %>
  <div class="search-no-results">
    <%= sprite_icon('search') %>
    <h4><%= l(:label_no_data) %></h4>
    <p><%= l(:text_no_search_results) %></p>
  </div>
<% end %>

<%= javascript_tag do %>
// Keyboard navigation for search results
(function() {
  const resultsList = document.getElementById('search-results-list');
  if (!resultsList) return;

  const results = resultsList.querySelectorAll('.search-result-card');
  let currentIndex = -1;

  function navigateResult(direction) {
    if (results.length === 0) return;

    if (currentIndex >= 0 && currentIndex < results.length) {
      results[currentIndex].classList.remove('keyboard-focus');
    }

    currentIndex = currentIndex + direction;
    if (currentIndex < 0) currentIndex = 0;
    if (currentIndex >= results.length) currentIndex = results.length - 1;

    results[currentIndex].classList.add('keyboard-focus');
    results[currentIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
  }

  function openCurrentResult() {
    if (currentIndex >= 0 && currentIndex < results.length) {
      const link = results[currentIndex].querySelector('.search-result-title');
      if (link) link.click();
    }
  }

  document.addEventListener('keydown', function(e) {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
      return;
    }

    switch(e.key) {
      case 'j':
        e.preventDefault();
        navigateResult(1);
        break;
      case 'k':
        e.preventDefault();
        navigateResult(-1);
        break;
      case 'Enter':
        if (currentIndex >= 0) {
          e.preventDefault();
          openCurrentResult();
        }
        break;
      case '/':
        e.preventDefault();
        document.getElementById('search-input').focus();
        break;
    }
  });

  results.forEach(function(card, index) {
    card.addEventListener('click', function(e) {
      if (e.target.tagName !== 'A') {
        if (currentIndex >= 0) {
          results[currentIndex].classList.remove('keyboard-focus');
        }
        currentIndex = index;
        card.classList.add('keyboard-focus');
      }
    });
  });
})();
<% end %>
