<!DOCTYPE html>
<html lang="<%= current_language %>" dir="<%= l(:direction) %>">
<head>
<meta charset="utf-8" />
<title><%= html_title %></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="<%= Redmine::Info.app_name %>" />
<meta name="keywords" content="issue,bug,tracker" />
<%= csrf_meta_tag %>
<%= favicon %>
<!-- Google Fonts - Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<%= stylesheet_link_tag 'jquery/jquery-ui-1.13.2', 'tribute-5.1.3', 'mermaid', 'redmine-bootstrap', :media => 'all' %>
<%= javascript_importmap_tags %>
<%= javascript_heads %>
<%= heads_for_theme %>
<%= heads_for_i18n %>
<%= heads_for_auto_complete(@project) %>
<%= call_hook :view_layouts_base_html_head %>
<!-- page specific tags -->
<%= yield :header_tags -%>
</head>
<body class="<%= body_css_classes %>" data-text-formatting="<%= Setting.text_formatting %>">
<%= call_hook :view_layouts_base_body_top %>
<div id="wrapper">

<!-- Bootstrap Offcanvas Menu (Mobile) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="flyoutMenu" aria-labelledby="flyoutMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="flyoutMenuLabel"><%= Redmine::Info.app_name %></h5>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <% if User.current.logged? || !Setting.login_required? %>
      <div class="mb-3">
        <%= form_tag(search_path(id: @project), :method => :get, class: 'd-flex') do %>
          <%= hidden_field_tag(controller.default_search_scope, 1, :id => nil) if controller.default_search_scope %>
          <%= text_field_tag 'q', @question, :id => 'flyout-search', :class => 'form-control form-control-sm me-2', :placeholder => l(:label_search) %>
          <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-search"></i>
          </button>
        <% end %>
      </div>
    <% end %>

    <% if User.current.logged? %>
      <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
        <%= link_to(avatar(User.current, :size => "40"), user_path(User.current), class: 'me-2') %>
        <%= link_to_user(User.current, :format => :username) %>
      </div>
    <% end %>

    <% if display_main_menu?(@project) %>
      <h6 class="text-muted text-uppercase small fw-semibold mb-2"><%= l(:label_project) %></h6>
      <div class="js-project-menu mb-3"></div>
    <% end %>

    <h6 class="text-muted text-uppercase small fw-semibold mb-2"><%= l(:label_general) %></h6>
    <div class="offcanvas-general-menu mb-3">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house me-2"></i>Home</a></li>
        <li class="nav-item"><a class="nav-link" href="/my/page"><i class="bi bi-person me-2"></i>My page</a></li>
        <li class="nav-item"><a class="nav-link" href="/projects"><i class="bi bi-folder me-2"></i>Projects</a></li>
        <% if User.current.admin? %>
        <li class="nav-item"><a class="nav-link" href="/admin"><i class="bi bi-gear me-2"></i>Administration</a></li>
        <% end %>
        <li class="nav-item"><a class="nav-link" href="https://www.redmine.org/guide" target="_blank" rel="noopener"><i class="bi bi-question-circle me-2"></i>Help</a></li>
      </ul>
    </div>

    <div class="offcanvas-sidebar mb-3"></div>

    <h6 class="text-muted text-uppercase small fw-semibold mb-2"><%= l(:label_profile) %></h6>
    <div class="offcanvas-profile-menu">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link" href="/my/account"><i class="bi bi-person-gear me-2"></i>My account</a></li>
        <% if User.current.logged? %>
        <li class="nav-item"><a class="nav-link" href="/logout" data-method="post" rel="nofollow"><i class="bi bi-box-arrow-right me-2"></i>Sign out</a></li>
        <% end %>
      </ul>
    </div>
  </div>
</div>

<!-- Top Navigation Bar -->
<div id="top-menu">
    <div id="account">
        <%= render_menu :account_menu -%>
    </div>
    <%= content_tag('div', "#{l(:label_logged_as)} #{link_to_user(User.current, :format => :username)}".html_safe, :id => 'loggedas') if User.current.logged? %>
    <%= render_menu :top_menu if User.current.logged? || !Setting.login_required? -%>
</div>

<!-- Header -->
<div id="header">
    <!-- Mobile menu toggle -->
    <button class="d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#flyoutMenu" aria-controls="flyoutMenu" aria-label="Menu">
      <i class="bi bi-list"></i>
    </button>
    <% if User.current.logged? || !Setting.login_required? %>
    <div id="quick-search">
        <%= form_tag(search_path(id: @project), :method => :get) do %>
        <%= hidden_field_tag 'scope', default_search_project_scope, :id => nil %>
        <%= hidden_field_tag(controller.default_search_scope, 1, :id => nil) if controller.default_search_scope %>
        <label for='q' class="visually-hidden">
          <%= link_to l(:label_search), search_path(id: @project, :scope => default_search_project_scope), :accesskey => accesskey(:search) %>
        </label>
        <%= text_field_tag 'q', @question, :size => 20, :placeholder => l(:label_search), :accesskey => accesskey(:quick_search),
                            :data => {
                                :auto_complete => true
                            } %>
        <% end %>
        <%= render_project_jump_box %>
    </div>
    <% end %>

    <h1><%= page_header_title %></h1>

    <% if display_main_menu?(@project) %>
    <div id="main-menu" class="tabs">
        <%= render_main_menu(@project) %>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left icon-only" onclick="moveTabLeft(this); return false;">
              <%= sprite_icon("angle-left", rtl: true) %>
            </button>
            <button class="tab-right icon-only" onclick="moveTabRight(this); return false;">
              <%= sprite_icon("angle-right", rtl: true) %>
            </button>
        </div>
    </div>
    <% end %>
</div>

<!-- Main Content Area -->
<div id="main" class="<%= sidebar_content? ? 'collapsiblesidebar' : 'nosidebar' %>">
  <%= javascript_tag "$('#main.collapsiblesidebar').collapsibleSidebar();" if sidebar_content? %>
    <div id="sidebar">
        <% if sidebar_content? %>
          <div id="sidebar-switch-panel" style="visibility: hidden;">
            <a id="sidebar-switch-button" href="#">
              <%= sprite_icon("chevrons-right", size: 20, rtl: true) %></a>
          </div>
          <%= javascript_tag "$('#sidebar-switch-panel').css('visibility', 'visible');" %>
        <% end %>
        <div id="sidebar-wrapper">
          <%= yield :sidebar %>
          <%= view_layouts_base_sidebar_hook_response %>
        </div>
    </div>

    <div id="content">
        <%= render_flash_messages %>
        <%= yield %>
        <%= call_hook :view_layouts_base_content %>
    </div>
</div>

<!-- Footer -->
<div id="footer">
    Powered by <%= link_to Redmine::Info.app_name, Redmine::Info.url, :target => '_blank', :rel => 'noopener' %> &copy; 2006-2026 Jean-Philippe Lang
</div>

<!-- Ajax Indicator -->
<div id="ajax-indicator" style="display:none;">
  <div class="spinner-wrap">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden"><%= l(:label_loading) %></span>
    </div>
    <span class="ms-2"><%= l(:label_loading) %></span>
  </div>
</div>

<!-- Ajax Modal -->
<div id="ajax-modal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= l(:button_cancel) %></button>
      </div>
    </div>
  </div>
</div>

<div id="icon-copy-source" style="display: none;"><%= sprite_icon('') %></div>

</div>
<%= call_hook :view_layouts_base_body_bottom %>
<script type="module">
// Mermaid.js diagram rendering
(async function() {
  const codeBlocks = document.querySelectorAll('pre > code[data-language="mermaid"]');
  if (codeBlocks.length === 0) return;

  try {
    const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    codeBlocks.forEach(function(code) {
      const pre = code.parentElement;
      const text = code.textContent;
      pre.className = 'mermaid';
      pre.textContent = text;
    });

    await mermaid.run();
  } catch (error) {
    console.error('Mermaid rendering failed:', error);
  }
})();
</script>
</body>
</html>
