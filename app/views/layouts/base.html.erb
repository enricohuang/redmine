<!DOCTYPE html>
<html lang="<%= current_language %>" dir="<%= l(:direction) %>">
<head>
<meta charset="utf-8" />
<title><%= html_title %></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="<%= Redmine::Info.app_name %>" />
<meta name="keywords" content="issue,bug,tracker" />
<%= csrf_meta_tag %>
<%= favicon %>
<!-- Bootstrap 5.3 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<%= stylesheet_link_tag 'jquery/jquery-ui-1.13.2', 'tribute-5.1.3', 'redmine-bootstrap', 'application', 'responsive', 'mermaid', :media => 'all' %>
<%= javascript_importmap_tags %>
<%= javascript_heads %>
<%= heads_for_theme %>
<%= heads_for_i18n %>
<%= heads_for_auto_complete(@project) %>
<%= call_hook :view_layouts_base_html_head %>
<!-- page specific tags -->
<%= yield :header_tags -%>
</head>
<body class="<%= body_css_classes %>" data-text-formatting="<%= Setting.text_formatting %>">
<%= call_hook :view_layouts_base_body_top %>
<div id="wrapper" class="d-flex flex-column min-vh-100">

<!-- Bootstrap Offcanvas Menu (Mobile) -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="flyoutMenu" aria-labelledby="flyoutMenuLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="flyoutMenuLabel"><%= Redmine::Info.app_name %></h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <% if User.current.logged? || !Setting.login_required? %>
      <div class="mb-3">
        <%= form_tag(search_path(id: @project), :method => :get, class: 'd-flex') do %>
          <%= hidden_field_tag(controller.default_search_scope, 1, :id => nil) if controller.default_search_scope %>
          <%= text_field_tag 'q', @question, :id => 'flyout-search', :class => 'form-control form-control-sm me-2', :placeholder => l(:label_search) %>
          <button type="submit" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-search"></i>
          </button>
        <% end %>
      </div>
    <% end %>

    <% if User.current.logged? %>
      <div class="d-flex align-items-center mb-3 p-2 bg-light rounded">
        <%= link_to(avatar(User.current, :size => "40"), user_path(User.current), class: 'me-2') %>
        <%= link_to_user(User.current, :format => :username) %>
      </div>
    <% end %>

    <% if display_main_menu?(@project) %>
      <h6 class="text-muted text-uppercase small"><%= l(:label_project) %></h6>
      <div class="js-project-menu mb-3"></div>
    <% end %>

    <h6 class="text-muted text-uppercase small"><%= l(:label_general) %></h6>
    <div class="js-general-menu mb-3"></div>

    <div class="js-sidebar flyout-menu__sidebar mb-3"></div>

    <h6 class="text-muted text-uppercase small"><%= l(:label_profile) %></h6>
    <div class="js-profile-menu"></div>
  </div>
</div>

<!-- Legacy flyout menu (for JS compatibility) -->
<div class="flyout-menu js-flyout-menu d-none">
    <% if User.current.logged? || !Setting.login_required? %>
        <div class="flyout-menu__search">
            <%= form_tag(search_path(id: @project), :method => :get ) do %>
            <%= hidden_field_tag(controller.default_search_scope, 1, :id => nil) if controller.default_search_scope %>
            <%= label_tag 'flyout-search-legacy', sprite_icon('search', l(:label_search), icon_only: true), :class => 'search-magnifier search-magnifier--flyout' %>
            <%= text_field_tag 'q', @question, :id => 'flyout-search-legacy', :class => 'small js-search-input', :placeholder => l(:label_search) %>
            <% end %>
        </div>
    <% end %>

    <% if User.current.logged? %>
        <div class="flyout-menu__avatar">
          <%= link_to(avatar(User.current, :size => "40"), user_path(User.current)) %>
          <%= link_to_user(User.current, :format => :username) %>
        </div>
    <% end %>

    <% if display_main_menu?(@project) %>
        <h3><%= l(:label_project) %></h3>
        <span class="js-project-menu"></span>
    <% end %>

    <h3><%= l(:label_general) %></h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3><%= l(:label_profile) %></h3>
    <span class="js-profile-menu"></span>
</div>

<!-- Top Menu Bar (Bootstrap Navbar) -->
<nav id="top-menu" class="navbar navbar-dark py-1 px-3" style="background-color: #3E5B76;">
  <div class="container-fluid px-0">
    <div class="d-flex align-items-center flex-grow-1">
      <% if User.current.logged? || !Setting.login_required? %>
        <ul class="navbar-nav flex-row me-auto">
          <%= render_menu :top_menu %>
        </ul>
      <% end %>
    </div>
    <div class="d-flex align-items-center">
      <% if User.current.logged? %>
        <span id="loggedas" class="text-white small me-3">
          <%= l(:label_logged_as) %> <%= link_to_user(User.current, :format => :username) %>
        </span>
      <% end %>
      <div id="account">
        <%= render_menu :account_menu -%>
      </div>
    </div>
  </div>
</nav>

<!-- Header Section -->
<header id="header" class="position-relative" style="background: linear-gradient(180deg, #628DB6 30%, #356D92); color: #f8f9fa; padding: 0.5rem 1.25rem 1.25rem;">
  <div class="container-fluid px-0">
    <div class="row align-items-center">
      <div class="col-auto d-lg-none">
        <!-- Mobile menu toggle (Bootstrap offcanvas trigger) -->
        <button class="btn btn-link text-white p-0 me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#flyoutMenu" aria-controls="flyoutMenu">
          <i class="bi bi-list fs-4"></i>
        </button>
        <!-- Legacy toggle for JS compatibility -->
        <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button d-none"></a>
      </div>
      <div class="col">
        <h1 class="h4 mb-0 text-white text-truncate"><%= page_header_title %></h1>
      </div>
      <% if User.current.logged? || !Setting.login_required? %>
      <div class="col-auto d-none d-lg-block">
        <div id="quick-search" class="d-flex align-items-center">
          <%= form_tag(search_path(id: @project), :method => :get, class: 'd-flex align-items-center') do %>
            <%= hidden_field_tag 'scope', default_search_project_scope, :id => nil %>
            <%= hidden_field_tag(controller.default_search_scope, 1, :id => nil) if controller.default_search_scope %>
            <label for='q' class="me-2 small">
              <%= link_to l(:label_search), search_path(id: @project, :scope => default_search_project_scope), :accesskey => accesskey(:search), class: 'text-white' %>:
            </label>
            <%= text_field_tag 'q', @question, :size => 20, :class => 'form-control form-control-sm', :accesskey => accesskey(:quick_search),
                                :style => 'width: 150px;',
                                :data => {
                                    :auto_complete => true
                                } %>
          <% end %>
          <%= render_project_jump_box %>
        </div>
      </div>
      <% end %>
    </div>
  </div>

  <% if display_main_menu?(@project) %>
  <!-- Main Menu (Project Navigation Tabs) -->
  <nav id="main-menu" class="tabs mt-3">
    <ul class="nav nav-tabs border-0">
      <%= render_main_menu(@project) %>
    </ul>
    <div class="tabs-buttons" style="display:none;">
      <button class="tab-left btn btn-link text-white p-1" onclick="moveTabLeft(this); return false;">
        <%= sprite_icon("angle-left", rtl: true) %>
      </button>
      <button class="tab-right btn btn-link text-white p-1" onclick="moveTabRight(this); return false;">
        <%= sprite_icon("angle-right", rtl: true) %>
      </button>
    </div>
  </nav>
  <% end %>
</header>

<!-- Main Content Area -->
<main id="main" class="flex-grow-1 <%= sidebar_content? ? 'collapsiblesidebar' : 'nosidebar' %>">
  <%= javascript_tag "$('#main.collapsiblesidebar').collapsibleSidebar();" if sidebar_content? %>
  <div class="container-fluid h-100">
    <div class="row h-100">
      <!-- Content Column -->
      <div id="content" class="col-12 <%= sidebar_content? ? 'col-lg-9' : '' %> py-3 px-4 order-lg-1">
        <%= render_flash_messages %>
        <%= yield %>
        <%= call_hook :view_layouts_base_content %>
      </div>

      <% if sidebar_content? %>
      <!-- Sidebar Column -->
      <aside id="sidebar" class="col-12 col-lg-3 py-3 order-lg-2 bg-light border-start">
        <div id="sidebar-switch-panel" class="d-none d-lg-block mb-2" style="visibility: hidden;">
          <a id="sidebar-switch-button" class="btn btn-sm btn-outline-secondary" href="#">
            <%= sprite_icon("chevrons-right", size: 20, rtl: true) %>
          </a>
        </div>
        <%= javascript_tag "$('#sidebar-switch-panel').css('visibility', 'visible');" %>
        <div id="sidebar-wrapper">
          <%= yield :sidebar %>
          <%= view_layouts_base_sidebar_hook_response %>
        </div>
      </aside>
      <% end %>
    </div>
  </div>
</main>

<!-- Footer -->
<footer id="footer" class="bg-light border-top py-2 px-3 text-center text-muted small">
  Powered by <%= link_to Redmine::Info.app_name, Redmine::Info.url, :target => '_blank', :rel => 'noopener' %> &copy; 2006-2026 Jean-Philippe Lang
</footer>

<!-- Ajax Indicator -->
<div id="ajax-indicator" class="position-fixed top-50 start-50 translate-middle" style="display:none; z-index: 1060;">
  <div class="bg-white rounded shadow p-3 d-flex align-items-center">
    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
      <span class="visually-hidden"><%= l(:label_loading) %></span>
    </div>
    <span><%= l(:label_loading) %></span>
  </div>
</div>

<!-- Ajax Modal (Bootstrap Modal) -->
<div id="ajax-modal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><%= l(:button_cancel) %></button>
      </div>
    </div>
  </div>
</div>

<div id="icon-copy-source" style="display: none;"><%= sprite_icon('') %></div>

</div>
<%= call_hook :view_layouts_base_body_bottom %>
<script type="module">
// Mermaid.js diagram rendering
// Only loads Mermaid.js when mermaid code blocks are present on the page
(async function() {
  const codeBlocks = document.querySelectorAll('pre > code[data-language="mermaid"]');
  if (codeBlocks.length === 0) return;

  try {
    const { default: mermaid } = await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    codeBlocks.forEach(function(code) {
      const pre = code.parentElement;
      const text = code.textContent;
      pre.className = 'mermaid';
      pre.textContent = text;
    });

    await mermaid.run();
  } catch (error) {
    console.error('Mermaid rendering failed:', error);
  }
})();
</script>
</body>
</html>
